format_version: 4
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
    - DOPPLER_TOKEN: $DOPPLER_TOKEN
    - DOPPLER_PROJECT: $DOPPLER_PROJECT
    - DOPPLER_CONFIG: $DOPPLER_CONFIG

workflows:
  test:
    steps:
      - script:
          inputs:
            - content: |
                #!/bin/bash
                echo "Testing Doppler Bitrise Step."
      - path::./:
          title: Doppler Step Test
          description: Test the Doppler step with required inputs.
          inputs:
            - DOPPLER_TOKEN: $DOPPLER_TOKEN
            - DOPPLER_PROJECT: $DOPPLER_PROJECT
            - DOPPLER_CONFIG: $DOPPLER_CONFIG
  audit-this-step:
    steps:
      - script:
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                stepman audit --step-yml ./step.yml

  share-this-step:
    envs:
      - MY_STEPLIB_REPO_FORK_GIT_URL: $MY_STEPLIB_REPO_FORK_GIT_URL
      - BITRISE_STEP_ID: $BITRISE_STEP_ID
      - BITRISE_STEP_VERSION: $BITRISE_STEP_VERSION
      - BITRISE_STEP_GIT_CLONE_URL: $BITRISE_STEP_GIT_CLONE_URL
    before_run:
      - audit-this-step
    steps:
      - script:
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                bitrise share start -c "${MY_STEPLIB_REPO_FORK_GIT_URL}"
                bitrise share create --stepid "${BITRISE_STEP_ID}" --tag "${BITRISE_STEP_VERSION}" --git "${BITRISE_STEP_GIT_CLONE_URL}"
                bitrise share finish